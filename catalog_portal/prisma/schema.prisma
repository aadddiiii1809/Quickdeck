generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum QcStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AttributeValueType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
  JSON
}

model Category {
  id                String              @id @default(uuid()) @db.Uuid
  name              String
  slug              String              @unique
  parentId          String?             @db.Uuid
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  parent            Category?           @relation("CategoryTree", fields: [parentId], references: [id])
  children          Category[]          @relation("CategoryTree")
  products          Product[]
  categoryAttributes CategoryAttribute[]

  @@index([parentId])
}

model Product {
  id               String                  @id @default(uuid()) @db.Uuid
  sellerId         String?                 @db.Uuid
  categoryId       String                  @db.Uuid
  sku              String                  @unique
  name             String
  description      String?
  brand            String?
  hsnCode          String?
  mrp              Decimal                 @db.Decimal(12, 2)
  sellingPrice     Decimal                 @db.Decimal(12, 2)
  currency         String                  @default("INR") @db.Char(3)
  primaryImageUrl  String?
  qcStatus         QcStatus                @default(PENDING)
  qcReason         String?
  createdBy        String?                 @db.Uuid
  approvedBy       String?                 @db.Uuid
  approvedAt       DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  category         Category                @relation(fields: [categoryId], references: [id])
  images           ProductImage[]
  attributeValues  ProductAttributeValue[]
  variants         ProductVariant[]
  qcLogs           QcLog[]

  @@index([categoryId])
  @@index([qcStatus])
}

model ProductImage {
  id        String   @id @default(uuid()) @db.Uuid
  productId String   @db.Uuid
  imageUrl  String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Attribute {
  id          String                @id @default(uuid()) @db.Uuid
  code        String                @unique
  name        String
  valueType   AttributeValueType
  isFilterable Boolean              @default(true)
  isSearchable Boolean              @default(false)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  categoryAttributes CategoryAttribute[]
  productValues ProductAttributeValue[]
}

model CategoryAttribute {
  id          String   @id @default(uuid()) @db.Uuid
  categoryId  String   @db.Uuid
  attributeId String   @db.Uuid
  isRequired  Boolean  @default(false)
  sortOrder   Int      @default(0)
  helpText    String?
  allowedValues Json?
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([categoryId, attributeId])
  @@index([categoryId])
}

model ProductAttributeValue {
  id           String    @id @default(uuid()) @db.Uuid
  productId    String    @db.Uuid
  attributeId  String    @db.Uuid
  valueText    String?
  valueNumber  Decimal?  @db.Decimal(14, 4)
  valueBoolean Boolean?
  valueDate    DateTime? @db.Date
  valueJson    Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute    Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@index([productId])
}

model ProductVariant {
  id           String     @id @default(uuid()) @db.Uuid
  productId    String     @db.Uuid
  variantSku   String     @unique
  color        String?
  size         String?
  mrp          Decimal?   @db.Decimal(12, 2)
  sellingPrice Decimal?   @db.Decimal(12, 2)
  barcode      String?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory    Inventory?

  @@index([productId])
}

model Inventory {
  id               String         @id @default(uuid()) @db.Uuid
  variantId        String         @unique @db.Uuid
  quantity         Int            @default(0)
  reservedQuantity Int            @default(0)
  reorderLevel     Int            @default(0)
  updatedAt        DateTime       @updatedAt
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model QcLog {
  id             String    @id @default(uuid()) @db.Uuid
  productId      String    @db.Uuid
  previousStatus QcStatus
  newStatus      QcStatus
  reason         String?
  reviewedBy     String?   @db.Uuid
  createdAt      DateTime  @default(now())
  product        Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}
